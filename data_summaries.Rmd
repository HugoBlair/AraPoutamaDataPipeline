---
title: "data summaries"
author: "Kaito Ibaraki"
date: "2024-09-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#loads all sheets into dataframes

```{r}

library(readxl)
library(dplyr)
library(ggplot2)
library(docxtractr)


# Define the file path
path <- "pp8_primhd_waittimes_20240829_JUN23MAY24 (deident).xlsx"

# Read each sheet into a dataframe with the corresponding name
DHBs_all_team_types <- read_excel(path, sheet = "table1")
NGOs_All_team_types <- read_excel(path, sheet = "table2")
DHB_MH_teams <- read_excel(path, sheet = "table3")
DHB_AOD_teams <- read_excel(path, sheet = "table4")
NGO_MH_teams <- read_excel(path, sheet = "table5")
NGO_AOD_teams <- read_excel(path, sheet = "table6")
Forensic_teams <- read_excel(path, sheet = "table7")
Exceptions <- read_excel(path, sheet = "table8")
No_contract_DHB <- read_excel(path, sheet = "table9")


```

# Creates a list of dataframes 

```{r}

dataframes <- list(
  DHBs_all_team_types,
  NGOs_All_team_types,
  DHB_MH_teams,
  DHB_AOD_teams,
  NGO_MH_teams,
  NGO_AOD_teams,
  Forensic_teams,
  Exceptions,
  No_contract_DHB
)

df_names <- c("DHBs_all_team_types", "NGOs_All_team_types", "DHB_MH_teams", 
              "DHB_AOD_teams", "NGO_MH_teams", "NGO_AOD_teams", 
              "Forensic_teams", "Exceptions", "No_contract_DHB")



```
# summarises wait days by table

```{r}

mean_wait_days <- sapply(dataframes, function(df){
  round(mean(df$WAIT_DAYS, na.rm= TRUE),2)
})

mean_summary <- data.frame(Table = df_names, Mean_WAIT_DAYS = mean_wait_days)

mean_summary



median_wait_days <- sapply(dataframes, function(df){
  median(df$WAIT_DAYS, na.rm= TRUE)
})

median_summary <- data.frame(Table = df_names, median_WAIT_DAYS = median_wait_days)

median_summary



```

#creates a table of mean wait days per organisation for each table

```{r}


mean_waits_per_organisation=list()

# calculates mean wait days per organisation for each dataframe
for (i in 1:length(dataframes)) {
  mean_table <- dataframes[[i]] %>%
    group_by(ORGANISATION_NAME) %>%  
    summarise(Mean_WAIT_DAYS = mean(WAIT_DAYS, na.rm = TRUE))  

  
  mean_waits_per_organisation[[df_names[i]]] <- mean_table
}


calculate_waits <- function(group, measure){
  result_list=list()
  for (i in 1:length(dataframes)) {
    mean_table <- dataframes[[i]] %>%
      group_by({{group}}) %>%  
      summarise(Mean_WAIT_DAYS = round(measure(WAIT_DAYS, na.rm = TRUE),2))  
  result_list[[df_names[i]]] <- mean_table
  }
  return(result_list)
}

mean_waits_per_organisation <- calculate_waits(ORGANISATION_NAME, mean)
median_waits_per_organisation <-calculate_waits(ORGANISATION_NAME, median)

mean_waits_per_ageGroup <- calculate_waits(AGE_GROUP, mean)
median_waits_per_ageGroup <- calculate_waits(AGE_GROUP, median)


calculate_waits(REFERRAL_FROM, mean)

table(DHBs_all_team_types$REFERRAL_FROM)
```

```{r}


ggplot(mean_waits_per_organisation[[df_names[[3]]]], aes(x = reorder(ORGANISATION_NAME, Mean_WAIT_DAYS), y = Mean_WAIT_DAYS)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() + 
  labs(x = "Organisation Name", y = "Mean Wait Days", title = "Mean Wait Days by Organisation") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))
```

```{r}

ggplot(mean_waits_per_organisation[[df_names[[1]]]], aes(x = reorder(ORGANISATION_NAME, Mean_WAIT_DAYS), y = Mean_WAIT_DAYS)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  coord_flip() +  
  labs(x = "Organisation Name", y = "Mean Wait Days", title = "Mean Wait Days by Organisation") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))

```




```{r}

referralEnds=c("Not Applicable",
               "Ended Routinely",
               "Discharged to other service within organisation",
               "Provider discharge",
               "Transfer to another MHA service within same organisation","Domiciliary",
               "self discharge",
               "Discharge of tangata whaiora/consumer to another healthcare organisation", "Involunatry Discharge","Deceased",
               "Gone No Address or Lost to follow-up",
               "Discharge of tangata whaiora/consumer to NGOs that provide MHA services")

referralEndsDescriptions=c("N/A",
  "Completion of treatment/programme/goals. Use this for discharge/return to GP.",
  "Discharge to a non-mental health and addiction service within the same organisation","Provider cannot continue to provide service eg tangata whaiora/consumer was a risk to others / did not adhere to agreed programme",
  "Use this code for internal transfers between mental health and addiction teams","Services provided to a tangata whaiora/consumer in the tangata whaiora/consumer’s or family/whānau member’s home. ",
  "Tangata whaiora/consumer has informed the service provider they no longer wish to receive services and discharge has resulted.",
  "Use this code for:
•	discharge to a non-MHA organisation 
•	discharge from an NGO to Health NZ services (either MHA or non-MHA service)
•	discharge from one Health NZ service to another (either MHA or non-MHA service)
•	discharge to a private provider (not GP)
For discharges to NGOs providing MHA services use code DK.
For discharges to GP use code DR.
",
  "Use this code for:
•	discharge to a non-MHA organisation 
•	discharge from an NGO to Health NZ services (either MHA or non-MHA service)
•	discharge from one Health NZ service to another (either MHA or non-MHA service)
•	discharge to a private provider (not GP)
For discharges to NGOs providing MHA services use code DK.
For discharges to GP use code DR.
",
  "Tangata whaiora/consumer died while registered with team.","Tangata whaiora/consumer who has been receiving service is unable to be contacted and decision is made to end the referral. Providers should have a local protocol in place to determine when discharge should occur",
  "Use this code for transitions to NGOs when the NGO will be the primary provider of that consumer’s MHA services.
To be used for Health NZ services to NGO and also NGO to NGO transfers.
")
endcodes=unique(DHBs_all_team_types$REFERRAL_END_CODE)
endcodes

endcodesAllInfo=cbind(endcodes,referralEnds,referralEndsDescriptions)

colnames(endcodesAllInfo) <- c("endcodes","referralEnds","referralEndsDescriptions")

endcodesAllInfo

```

# Extracting names from codeset document

```{r}


# Read the codeset
doc <- read_docx("HISO-10023.3-2024-PRIMHD-Code-Set-Standard.docx")



# Get the number of tables
num_tables <- docx_tbl_count(doc)

#save each table to a list entry
tables <- list()
for (i in 1:num_tables) {
  tables[[i]] <- docx_extract_tbl(doc, i)
}

# open a df 
all_code_descriptions <- data.frame(Code = character(), Description = character(), 
                        UsedForComment = character(), stringsAsFactors = FALSE)
#save each code description to a row
for (tbl in tables) {
  if (all(c("Code", "Description", "Used.for.Comment") %in% colnames(tbl))) {
    selected_tbl <- tbl %>% select(Code, Description, `Used.for.Comment`)
    all_code_descriptions <- rbind(all_code_descriptions, selected_tbl)
  }
}




```


